
<script>

var isSomeInQueue = false;

function getGroovesharkUrl() {
  return "http://grooveshark.com/";
}

function isGroovesharkUrl(url) {
  var grooveshark = getGroovesharkUrl();
  if (url.indexOf(grooveshark) != 0)
    return false;
  return true;
}

function playOrPause() {
  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && isGroovesharkUrl(tab.url)) {
        if (isSomeInQueue) {
          chrome.tabs.executeScript(tab.id, {code: "document.getElementById('player_play_pause').click()"});
        } else {
          chrome.tabs.update(tab.id, {selected: true});
        }
        return;
      }
    }
    chrome.tabs.create({url: getGroovesharkUrl()});
  });
}



function init() {
  setIcon("grooveshark_disabled.png");
  getData();
}

function setIcon(icon) {
  chrome.browserAction.setIcon({path: icon+".png"});
}

function getData() {
  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && isGroovesharkUrl(tab.url)) {
        chrome.tabs.executeScript(tab.id, {file: "getData.js"});
        return;
      }
    }
    setIcon('grooveshark_disabled');
  });
  
  scheduleRequest();
}

function scheduleRequest() {
  var delay = 1000;
  window.setTimeout(getData, delay);
}



chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
    isSomeInQueue = request.isSomeInQueue;
    
    if (request.isSomeInQueue) {
      if (request.isPlaying) icon = 'grooveshark_pause';
      else icon = 'grooveshark_play';
    } else icon = 'grooveshark_disabled';
    setIcon(icon);
    
    document.getElementById("nowPlaying").innerHTML = request.artist + ' - ' + request.song;
  }
);

</script>

<body onload="init()" style="width: 200px;">
<button onclick="playOrPause();">Play/pause</button>
<div>Now playing: <span id="nowPlaying"></span></div>
</body>

