
<script>

var isSomeInQueue = false;

var actions = {
  'playOrPause': "$('#player_play_pause').click()",
  'shuffle': "$('#player_shuffle').click()",
  'loop': "$('#player_loop').click()",
  'crossfade': "$('#player_crossfade').click()",
  'previous': "$('#player_previous').click()",
  'next': "$('#player_next').click()"
}

function getGroovesharkUrl() {
  return "http://grooveshark.com/";
}

function isGroovesharkUrl(url) {
  var grooveshark = getGroovesharkUrl();
  if (url.indexOf(grooveshark) != 0)
    return false;
  return true;
}

function userBrowserAction(action) {
  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && isGroovesharkUrl(tab.url)) {
        if (isSomeInQueue) {
          chrome.tabs.executeScript(tab.id, {code: actions[action]});
        } else {
          chrome.tabs.update(tab.id, {selected: true});
        }
        return;
      }
    }
    chrome.tabs.create({url: getGroovesharkUrl()});
  });
}



function init() {
  setIcon("grooveshark_disabled.png");
  getData();
}

function setIcon(icon) {
  chrome.browserAction.setIcon({path: icon+".png"});
}

function getData() {
  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && isGroovesharkUrl(tab.url)) {
        chrome.tabs.executeScript(tab.id, {file: "getData.js"});
        return;
      }
    }
    setIcon('grooveshark_disabled');
  });
  
  scheduleRequest();
}

function scheduleRequest() {
  var delay = 1000;
  window.setTimeout(getData, delay);
}



chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
    isSomeInQueue = request.isSomeInQueue;
    
    if (request.isSomeInQueue) {
      if (request.isPlaying) icon = 'grooveshark_pause';
      else icon = 'grooveshark_play';
    } else icon = 'grooveshark_disabled';
    setIcon(icon);
    
    document.getElementById("nowPlaying").innerHTML = request.nowPlaying.artist + ' - ' + request.nowPlaying.song + ' (album: ' + request.nowPlaying.album + ')';
    document.getElementById("position").innerHTML = request.nowPlaying.positionInQueue;
    document.getElementById("timeElapsed").innerHTML = request.nowPlaying.times.elapsed;
    document.getElementById("timeDuration").innerHTML = request.nowPlaying.times.duration;
    
    document.getElementById("shuffle").innerHTML = request.playerOptions.shuffle;
    document.getElementById("loop").innerHTML = request.playerOptions.loop;
    document.getElementById("crossfade").innerHTML = request.playerOptions.crossfade;
  }
);

</script>

<body onload="init()" style="width: 200px;">
<button onclick="userBrowserAction('playOrPause');">Play/pause</button>
<button onclick="userBrowserAction('previous');">|<</button>
<button onclick="userBrowserAction('next');">>|</button>
<br />
<button onclick="userBrowserAction('shuffle');">Shuffle</button>
<button onclick="userBrowserAction('loop');">Loop</button>
<button onclick="userBrowserAction('crossfade');">Crossfade</button>
<br />
<div>Now playing: <span id="nowPlaying"></span></div>
<div>Position: <span id="position"></span></div>
<div>Time: <span id="timeElapsed"></span> of <span id="timeDuration"></span></div>
<div>shuffle: <span id="shuffle"></span></div>
<div>loop: <span id="loop"></span></div>
<div>crossfade: <span id="crossfade"></span></div>
</body>

